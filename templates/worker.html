<!DOCTYPE html>
<html>
<head>
    <title>Worker Details</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        .gpu-card {
            margin-bottom: 15px;
            border-left: 4px solid #0d6efd;
        }
        .command-card {
            margin-bottom: 10px;
        }
        .command-pending { background-color: #fff3cd; }
        .command-running { background-color: #d1ecf1; }
        .command-completed { background-color: #d4edda; }
        .command-failed { background-color: #f8d7da; }
        .command-stopping { background-color: #e2e3e5; }
        .command-stopped { background-color: #e2e3e5; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .metrics-chart {
            height: 250px;
            margin-bottom: 20px;
        }
        .chart-container {
            position: relative;
            margin-top: 20px;
        }
        .time-range-selector {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Worker: {{ worker.worker_id }}</h1>
            <a href="/" class="btn btn-primary">Back to Dashboard</a>
        </div>

        <div class="row">
            <!-- GPU Metrics Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">GPU Metrics</h5>
                    </div>
                    <div class="card-body">
                        {% set metrics = worker.get_metrics_json() %}
                        {% if metrics and metrics.gpus %}
                            {% for gpu in metrics.gpus %}
                                <div class="card gpu-card">
                                    <div class="card-body">
                                        <h5 class="card-title">GPU {{ loop.index }}: {{ gpu.model }}</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Temperature:</strong> {{ gpu.temp }}°C</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Utilization:</strong> {{ gpu.util }}%</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Temperature Progress Bar -->
                                        <div class="mb-2">
                                            <label class="form-label mb-0">Temperature</label>
                                            {% set temp_percent = (gpu.temp / 100) * 100 %}
                                            {% set temp_color = 'success' if gpu.temp < 70 else ('warning' if gpu.temp < 85 else 'danger') %}
                                            <div class="progress">
                                                <div class="progress-bar bg-{{ temp_color }}" role="progressbar" 
                                                     style="width: {{ temp_percent }}%" 
                                                     aria-valuenow="{{ gpu.temp }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ gpu.temp }}°C
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Utilization Progress Bar -->
                                        <div>
                                            <label class="form-label mb-0">Utilization</label>
                                            <div class="progress">
                                                <div class="progress-bar bg-info" role="progressbar" 
                                                     style="width: {{ gpu.util }}%" 
                                                     aria-valuenow="{{ gpu.util }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ gpu.util }}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                No GPU metrics available for this worker.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Metrics Timeline Section -->
                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Metrics Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="time-range-selector">
                            <label class="form-label">Time Range:</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm time-range" data-hours="1">1 Hour</button>
                                <button type="button" class="btn btn-outline-primary btn-sm time-range" data-hours="6">6 Hours</button>
                                <button type="button" class="btn btn-outline-primary btn-sm time-range active" data-hours="24">24 Hours</button>
                                <button type="button" class="btn btn-outline-primary btn-sm time-range" data-hours="72">3 Days</button>
                            </div>
                        </div>

                        {% if metrics and metrics.gpus %}
                            {% for gpu in metrics.gpus %}
                                <div class="card gpu-card">
                                    <div class="card-body">
                                        <h5 class="card-title">GPU {{ loop.index }} Timeline</h5>
                                        
                                        <div class="chart-container">
                                            <canvas id="tempChart{{ loop.index0 }}" class="metrics-chart"></canvas>
                                        </div>
                                        
                                        <div class="chart-container">
                                            <canvas id="utilChart{{ loop.index0 }}" class="metrics-chart"></canvas>
                                        </div>
                                        
                                        <div class="chart-container">
                                            <canvas id="memChart{{ loop.index0 }}" class="metrics-chart"></canvas>
                                        </div>
                                        
                                        <div class="chart-container">
                                            <canvas id="powerChart{{ loop.index0 }}" class="metrics-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                No GPU metrics available for this worker.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Commands Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Recent Commands</h5>
                    </div>
                    <div class="card-body">
                        <form action="/submit_command" method="post" class="mb-4">
                            <input type="hidden" name="worker_id" value="{{ worker.worker_id }}">
                            <div class="input-group">
                                <input type="text" class="form-control" name="command" placeholder="Enter command to run on this worker">
                                <button type="submit" class="btn btn-primary">Run Command</button>
                            </div>
                        </form>

                        {% if commands %}
                            <h6>Command History:</h6>
                            {% for command in commands %}
                                <div class="card command-card command-{{ command.status }}" id="command-{{ command.id }}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span><strong>{{ command.command_text }}</strong></span>
                                        <div>
                                            <span class="badge {% if command.status == 'pending' %}bg-warning
                                                {% elif command.status == 'running' %}bg-info
                                                {% elif command.status == 'completed' %}bg-success
                                                {% elif command.status == 'stopping' %}bg-secondary
                                                {% elif command.status == 'stopped' %}bg-secondary
                                                {% else %}bg-danger{% endif %}" id="status-{{ command.id }}">
                                                {{ command.status }}
                                            </span>
                                            {% if command.status == 'running' %}
                                            <form action="/stop_command/{{ command.id }}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-danger ms-2">Stop</button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <pre id="output-{{ command.id }}">{{ command.output or 'Waiting for output...' }}</pre>
                                        <small class="text-muted" id="updated-{{ command.id }}">Updated: {{ command.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                No commands have been run on this worker yet.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to update command output in real-time
        function updateCommandOutput() {
            {% for command in commands %}
                {% if command.status == 'running' or command.status == 'stopping' %}
                (function(commandId) {
                    fetch('/command_output/' + commandId)
                        .then(response => response.json())
                        .then(data => {
                            // Update the command output
                            document.getElementById('output-' + commandId).textContent = data.output || 'Waiting for output...';
                            document.getElementById('updated-' + commandId).textContent = 'Updated: ' + new Date(data.updated_at).toLocaleString();
                            
                            // Update the status badge
                            const statusBadge = document.getElementById('status-' + commandId);
                            statusBadge.textContent = data.status;
                            
                            // Update badge color based on status
                            statusBadge.className = 'badge';
                            if (data.status === 'pending') {
                                statusBadge.classList.add('bg-warning');
                            } else if (data.status === 'running') {
                                statusBadge.classList.add('bg-info');
                            } else if (data.status === 'completed') {
                                statusBadge.classList.add('bg-success');
                            } else if (data.status === 'stopping' || data.status === 'stopped') {
                                statusBadge.classList.add('bg-secondary');
                            } else {
                                statusBadge.classList.add('bg-danger');
                            }
                            
                            // Update card background color
                            const card = document.getElementById('command-' + commandId);
                            card.className = 'card command-card command-' + data.status;
                            
                            // Remove stop button if command is no longer running
                            if (data.status !== 'running') {
                                const stopButton = document.querySelector(`#command-${commandId} form`);
                                if (stopButton) {
                                    stopButton.remove();
                                }
                            }
                        })
                        .catch(error => console.error('Error updating command output:', error));
                })({{ command.id }});
                {% endif %}
            {% endfor %}
        }
        
        // Update command output every 2 seconds
        setInterval(updateCommandOutput, 2000);
        
        // Initial update
        updateCommandOutput();
        
        // Charts for GPU metrics
        {% if metrics and metrics.gpus %}
            {% for gpu in metrics.gpus %}
                // Initialize charts for GPU {{ loop.index0 }}
                let tempChart{{ loop.index0 }};
                let utilChart{{ loop.index0 }};
                let memChart{{ loop.index0 }};
                let powerChart{{ loop.index0 }};
                
                // Load initial data with 24 hours range
                loadMetricsData('{{ worker.worker_id }}', {{ loop.index0 }}, 24);
            {% endfor %}
            
            // Time range selector event listeners
            document.querySelectorAll('.time-range').forEach(button => {
                button.addEventListener('click', function() {
                    // Update active button
                    document.querySelectorAll('.time-range').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Get selected hours
                    const hours = parseInt(this.getAttribute('data-hours'));
                    
                    // Reload data for all GPUs
                    {% for gpu in metrics.gpus %}
                        loadMetricsData('{{ worker.worker_id }}', {{ loop.index0 }}, hours);
                    {% endfor %}
                });
            });
        {% endif %}
        
        // Function to load metrics data from API
        function loadMetricsData(workerId, gpuIndex, hours) {
            console.log(`Loading metrics data for worker ${workerId}, GPU ${gpuIndex}, hours: ${hours}`);
            fetch(`/api/metrics/history/${workerId}/${gpuIndex}?hours=${hours}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Received metrics data:`, data);
                    if (data.timestamps && data.timestamps.length > 0) {
                        console.log(`Got ${data.timestamps.length} data points`);
                        updateCharts(data, gpuIndex);
                    } else {
                        console.log(`No data points available yet. Charts will be empty.`);
                        // Still update charts with empty data to initialize them
                        updateCharts({
                            timestamps: [],
                            temperature: [],
                            utilization: [],
                            memory_utilization: [],
                            power_usage: []
                        }, gpuIndex);
                    }
                })
                .catch(error => {
                    console.error(`Error loading metrics data for GPU ${gpuIndex}:`, error);
                    // Display error message in the chart containers
                    document.querySelectorAll(`[id$='Chart${gpuIndex}']`).forEach(canvas => {
                        const ctx = canvas.getContext('2d');
                        ctx.font = '14px Arial';
                        ctx.fillStyle = 'red';
                        ctx.textAlign = 'center';
                        ctx.fillText('Error loading metrics data. Check console for details.', canvas.width/2, canvas.height/2);
                    });
                });
        }
        
        // Function to update charts with new data
        function updateCharts(data, gpuIndex) {
            const timestamps = data.timestamps.map(ts => new Date(ts));
            
            // Temperature chart
            updateChart(
                `tempChart${gpuIndex}`,
                timestamps,
                data.temperature,
                'Temperature (°C)',
                'rgba(255, 99, 132, 0.5)',
                'rgba(255, 99, 132, 1)'
            );
            
            // Utilization chart
            updateChart(
                `utilChart${gpuIndex}`,
                timestamps,
                data.utilization,
                'GPU Utilization (%)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(54, 162, 235, 1)'
            );
            
            // Memory utilization chart
            updateChart(
                `memChart${gpuIndex}`,
                timestamps,
                data.memory_utilization,
                'Memory Utilization (%)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(75, 192, 192, 1)'
            );
            
            // Power usage chart
            updateChart(
                `powerChart${gpuIndex}`,
                timestamps,
                data.power_usage,
                'Power Usage (W)',
                'rgba(153, 102, 255, 0.5)',
                'rgba(153, 102, 255, 1)'
            );
        }
        
        // Helper function to create or update a chart
        function updateChart(chartId, labels, data, label, backgroundColor, borderColor) {
            const ctx = document.getElementById(chartId);
            if (!ctx) {
                console.error(`Canvas element with ID ${chartId} not found`);
                return;
            }
            
            console.log(`Updating chart ${chartId} with ${labels.length} data points`);
            
            // Destroy existing chart if it exists
            if (window[chartId]) {
                window[chartId].destroy();
            }
            
            // If no data, show a message
            if (labels.length === 0) {
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width, ctx.height);
                context.font = '14px Arial';
                context.fillStyle = '#666';
                context.textAlign = 'center';
                context.fillText('No data available yet. Data will appear as metrics are collected.', ctx.width/2 || 150, ctx.height/2 || 100);
                return;
            }
            
            // Create new chart
            try {
                window[chartId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            borderWidth: 1,
                            tension: 0.1,
                            pointRadius: 0.5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    displayFormats: {
                                        hour: 'MMM d, HH:mm'
                                    },
                                    tooltipFormat: 'MMM d, HH:mm:ss'
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: label
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: label
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let value = context.parsed.y;
                                        if (label.includes('Temperature')) {
                                            return `${value}°C`;
                                        } else if (label.includes('Utilization') || label.includes('Memory')) {
                                            return `${value}%`;
                                        } else if (label.includes('Power')) {
                                            return `${value}W`;
                                        }
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`Error creating chart ${chartId}:`, error);
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width, ctx.height);
                context.font = '14px Arial';
                context.fillStyle = 'red';
                context.textAlign = 'center';
                context.fillText('Error creating chart. Check console for details.', ctx.width/2 || 150, ctx.height/2 || 100);
            }
        }
        
        // Don't refresh the page automatically if we're viewing metrics
        // Instead, update metrics data every 60 seconds
        const metricsUpdateInterval = setInterval(function() {
            {% if metrics and metrics.gpus %}
                {% for gpu in metrics.gpus %}
                    // Get current time range
                    const activeButton = document.querySelector('.time-range.active');
                    const hours = activeButton ? parseInt(activeButton.getAttribute('data-hours')) : 24;
                    
                    // Reload data
                    loadMetricsData('{{ worker.worker_id }}', {{ loop.index0 }}, hours);
                {% endfor %}
            {% endif %}
        }, 60000); // Update every minute
    </script>
</body>
</html>
