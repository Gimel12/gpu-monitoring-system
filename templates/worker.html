<!DOCTYPE html>
<html>
<head>
    <title>Worker Details</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        .gpu-card {
            margin-bottom: 15px;
            border-left: 4px solid #0d6efd;
        }
        .command-card {
            margin-bottom: 10px;
        }
        .command-pending { background-color: #fff3cd; }
        .command-running { background-color: #d1ecf1; }
        .command-completed { background-color: #d4edda; }
        .command-failed { background-color: #f8d7da; }
        .command-stopping { background-color: #e2e3e5; }
        .command-stopped { background-color: #e2e3e5; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .metrics-chart {
            height: 250px;
            margin-bottom: 20px;
        }
        .chart-container {
            position: relative;
            margin-top: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 10px;
            background-color: #ffffff;
        }
        .time-range-selector {
            margin-bottom: 15px;
        }
        .metric-view {
            transition: all 0.3s ease;
        }
        .metric-selector {
            max-width: 100%;
        }
        .card.bg-light {
            transition: all 0.2s ease;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card.bg-light:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .card-body.p-2.text-center h5 {
            font-weight: 600;
            font-size: 1.25rem;
            color: #333;
        }
        .text-muted {
            font-size: 0.8rem;
            font-weight: 500;
        }
        .btn-group .btn-outline-primary.active {
            background-color: #0d6efd;
            color: white;
        }
        .btn-group .btn-outline-secondary.active {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Worker: {{ worker.worker_id }}</h1>
            <a href="/" class="btn btn-primary">Back to Dashboard</a>
        </div>

        <div class="row">
            <!-- GPU Metrics Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">GPU Metrics</h5>
                    </div>
                    <div class="card-body">
                        {% set metrics = worker.get_metrics_json() %}
                        {% if metrics and metrics.gpus %}
                            {% for gpu in metrics.gpus %}
                                <div class="card gpu-card">
                                    <div class="card-body">
                                        <h5 class="card-title">GPU {{ loop.index }}: {{ gpu.model }}</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Temperature:</strong> {{ gpu.temp }}°C</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Utilization:</strong> {{ gpu.util }}%</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Temperature Progress Bar -->
                                        <div class="mb-2">
                                            <label class="form-label mb-0">Temperature</label>
                                            {% set temp_percent = (gpu.temp / 100) * 100 %}
                                            {% set temp_color = 'success' if gpu.temp < 70 else ('warning' if gpu.temp < 85 else 'danger') %}
                                            <div class="progress">
                                                <div class="progress-bar bg-{{ temp_color }}" role="progressbar" 
                                                     style="width: {{ temp_percent }}%" 
                                                     aria-valuenow="{{ gpu.temp }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ gpu.temp }}°C
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Utilization Progress Bar -->
                                        <div>
                                            <label class="form-label mb-0">Utilization</label>
                                            <div class="progress">
                                                <div class="progress-bar bg-info" role="progressbar" 
                                                     style="width: {{ gpu.util }}%" 
                                                     aria-valuenow="{{ gpu.util }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ gpu.util }}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                No GPU metrics available for this worker.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Metrics Timeline Section -->
                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Metrics Timeline</h5>
                    </div>
                    <div class="card-body">
                        {% if metrics and metrics.gpus %}
                            {% for gpu in metrics.gpus %}
                                <div class="card gpu-card mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title">GPU {{ loop.index }}: {{ gpu.model }}</h5>
                                        
                                        <!-- Controls row -->
                                        <div class="row mb-3">
                                            <!-- Time range selector -->
                                            <div class="col-md-8">
                                                <label class="form-label">Time Range:</label>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-primary btn-sm time-range" data-hours="1" data-gpu-index="{{ loop.index0 }}">1 Hour</button>
                                                    <button type="button" class="btn btn-outline-primary btn-sm time-range" data-hours="6" data-gpu-index="{{ loop.index0 }}">6 Hours</button>
                                                    <button type="button" class="btn btn-outline-primary btn-sm time-range active" data-hours="24" data-gpu-index="{{ loop.index0 }}">24 Hours</button>
                                                    <button type="button" class="btn btn-outline-primary btn-sm time-range" data-hours="72" data-gpu-index="{{ loop.index0 }}">3 Days</button>
                                                </div>
                                            </div>
                                            
                                            <!-- Metric selector -->
                                            <div class="col-md-4">
                                                <label for="metric-select-{{ loop.index0 }}" class="form-label">View Metric:</label>
                                                <select id="metric-select-{{ loop.index0 }}" class="form-select form-select-sm metric-selector" data-gpu-index="{{ loop.index0 }}">
                                                    <option value="all">All Metrics</option>
                                                    <option value="temperature">Temperature</option>
                                                    <option value="utilization">GPU Utilization</option>
                                                    <option value="memory_utilization">Memory Utilization</option>
                                                    <option value="power_usage">Power Usage</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Current metrics display -->
                                        <div class="row mb-3">
                                            <div class="col-md-3 mb-2">
                                                <div class="card bg-light">
                                                    <div class="card-body p-2 text-center">
                                                        <h5 class="mb-0">{{ gpu.temp }}°C</h5>
                                                        <small class="text-muted">Temperature</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="card bg-light">
                                                    <div class="card-body p-2 text-center">
                                                        <h5 class="mb-0">{{ gpu.util }}%</h5>
                                                        <small class="text-muted">GPU Usage</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="card bg-light">
                                                    <div class="card-body p-2 text-center">
                                                        <h5 class="mb-0">{{ gpu.memory.percent_used }}%</h5>
                                                        <small class="text-muted">Memory Usage</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <div class="card bg-light">
                                                    <div class="card-body p-2 text-center">
                                                        <h5 class="mb-0">{{ gpu.power_usage|default('N/A') }} W</h5>
                                                        <small class="text-muted">Power Usage</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Charts container -->
                                        <div class="metric-charts-container">
                                            <!-- All metrics view -->
                                            <div id="all-metrics-{{ loop.index0 }}" class="metric-view">
                                                <div class="chart-container mb-3">
                                                    <canvas id="tempChart{{ loop.index0 }}" class="metrics-chart"></canvas>
                                                </div>
                                                
                                                <div class="chart-container mb-3">
                                                    <canvas id="utilChart{{ loop.index0 }}" class="metrics-chart"></canvas>
                                                </div>
                                                
                                                <div class="chart-container mb-3">
                                                    <canvas id="memChart{{ loop.index0 }}" class="metrics-chart"></canvas>
                                                </div>
                                                
                                                <div class="chart-container mb-3">
                                                    <canvas id="powerChart{{ loop.index0 }}" class="metrics-chart"></canvas>
                                                </div>
                                            </div>
                                            
                                            <!-- Single metric views -->
                                            <div id="temperature-view-{{ loop.index0 }}" class="metric-view d-none">
                                                <div class="chart-container" style="height: 400px;">
                                                    <canvas id="singleTempChart{{ loop.index0 }}"></canvas>
                                                </div>
                                            </div>
                                            
                                            <div id="utilization-view-{{ loop.index0 }}" class="metric-view d-none">
                                                <div class="chart-container" style="height: 400px;">
                                                    <canvas id="singleUtilChart{{ loop.index0 }}"></canvas>
                                                </div>
                                            </div>
                                            
                                            <div id="memory_utilization-view-{{ loop.index0 }}" class="metric-view d-none">
                                                <div class="chart-container" style="height: 400px;">
                                                    <canvas id="singleMemChart{{ loop.index0 }}"></canvas>
                                                </div>
                                            </div>
                                            
                                            <div id="power_usage-view-{{ loop.index0 }}" class="metric-view d-none">
                                                <div class="chart-container" style="height: 400px;">
                                                    <canvas id="singlePowerChart{{ loop.index0 }}"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                No GPU metrics available for this worker.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Commands Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Recent Commands</h5>
                    </div>
                    <div class="card-body">
                        <form action="/submit_command" method="post" class="mb-4">
                            <input type="hidden" name="worker_id" value="{{ worker.worker_id }}">
                            <div class="input-group">
                                <input type="text" class="form-control" name="command" placeholder="Enter command to run on this worker">
                                <button type="submit" class="btn btn-primary">Run Command</button>
                            </div>
                        </form>

                        {% if commands %}
                            <h6>Command History:</h6>
                            {% for command in commands %}
                                <div class="card command-card command-{{ command.status }}" id="command-{{ command.id }}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span><strong>{{ command.command_text }}</strong></span>
                                        <div>
                                            <span class="badge {% if command.status == 'pending' %}bg-warning
                                                {% elif command.status == 'running' %}bg-info
                                                {% elif command.status == 'completed' %}bg-success
                                                {% elif command.status == 'stopping' %}bg-secondary
                                                {% elif command.status == 'stopped' %}bg-secondary
                                                {% else %}bg-danger{% endif %}" id="status-{{ command.id }}">
                                                {{ command.status }}
                                            </span>
                                            {% if command.status == 'running' %}
                                            <form action="/stop_command/{{ command.id }}" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-danger ms-2">Stop</button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <pre id="output-{{ command.id }}">{{ command.output or 'Waiting for output...' }}</pre>
                                        <small class="text-muted" id="updated-{{ command.id }}">Updated: {{ command.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                No commands have been run on this worker yet.
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- GPU Overclocking Section -->
                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">GPU Overclocking</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> Overclocking can potentially damage your hardware if not done carefully. 
                            Use these settings at your own risk.
                        </div>
                        
                        {% if metrics and metrics.gpus %}
                            <div id="power-limits-container" class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6>Power Limits</h6>
                                    <button id="refresh-power-limits" class="btn btn-sm btn-outline-secondary">Refresh Limits</button>
                                </div>
                                <div id="power-limits-loading" class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading power limits...</span>
                                </div>
                                <div id="power-limits-data" class="d-none">
                                    <!-- Power limits will be displayed here -->
                                </div>
                            </div>
                            
                            {% for gpu in metrics.gpus %}
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">GPU {{ loop.index }}: {{ gpu.model }}</h6>
                                    </div>
                                    <div class="card-body">
                                        <form id="tdp-form-{{ loop.index0 }}" class="tdp-form">
                                            <input type="hidden" name="worker_id" value="{{ worker.worker_id }}">
                                            <input type="hidden" name="gpu_index" value="{{ loop.index0 }}">
                                            
                                            <div class="mb-3">
                                                <label for="power-limit-{{ loop.index0 }}" class="form-label">Power Limit (TDP) in Watts:</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="power-limit-{{ loop.index0 }}" 
                                                           name="power_limit" min="50" max="500" step="5" 
                                                           placeholder="Enter power limit (W)" required>
                                                    <span class="input-group-text">W</span>
                                                    <button type="submit" class="btn btn-primary">Apply</button>
                                                </div>
                                                <div class="form-text">
                                                    Current: <span class="current-power-limit" data-gpu-index="{{ loop.index0 }}">Unknown</span>, 
                                                    Max: <span class="max-power-limit" data-gpu-index="{{ loop.index0 }}">Unknown</span>
                                                </div>
                                            </div>
                                            
                                            <div id="tdp-status-{{ loop.index0 }}" class="alert d-none"></div>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                No GPU metrics available for this worker. Cannot configure overclocking settings.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to update command output in real-time
        function updateCommandOutput() {
            {% for command in commands %}
                {% if command.status == 'running' or command.status == 'stopping' %}
                (function(commandId) {
                    fetch('/command_output/' + commandId)
                        .then(response => response.json())
                        .then(data => {
                            // Update the command output
                            document.getElementById('output-' + commandId).textContent = data.output || 'Waiting for output...';
                            document.getElementById('updated-' + commandId).textContent = 'Updated: ' + new Date(data.updated_at).toLocaleString();
                            
                            // Update the status badge
                            const statusBadge = document.getElementById('status-' + commandId);
                            statusBadge.textContent = data.status;
                            
                            // Update badge color based on status
                            statusBadge.className = 'badge';
                            if (data.status === 'pending') {
                                statusBadge.classList.add('bg-warning');
                            } else if (data.status === 'running') {
                                statusBadge.classList.add('bg-info');
                            } else if (data.status === 'completed') {
                                statusBadge.classList.add('bg-success');
                            } else if (data.status === 'stopping' || data.status === 'stopped') {
                                statusBadge.classList.add('bg-secondary');
                            } else {
                                statusBadge.classList.add('bg-danger');
                            }
                            
                            // Update card background color
                            const card = document.getElementById('command-' + commandId);
                            card.className = 'card command-card command-' + data.status;
                            
                            // Remove stop button if command is no longer running
                            if (data.status !== 'running') {
                                const stopButton = document.querySelector(`#command-${commandId} form`);
                                if (stopButton) {
                                    stopButton.remove();
                                }
                            }
                        })
                        .catch(error => console.error('Error updating command output:', error));
                })({{ command.id }});
                {% endif %}
            {% endfor %}
        }
        
        // Update command output every 2 seconds
        setInterval(updateCommandOutput, 2000);
        
        // Initial update
        updateCommandOutput();
        
        // Charts for GPU metrics
        {% if metrics and metrics.gpus %}
            {% for gpu in metrics.gpus %}
                // Initialize charts for GPU {{ loop.index0 }}
                let tempChart{{ loop.index0 }};
                let utilChart{{ loop.index0 }};
                let memChart{{ loop.index0 }};
                let powerChart{{ loop.index0 }};
                
                // Load initial data with 24 hours range
                loadMetricsData('{{ worker.worker_id }}', {{ loop.index0 }}, 24);
            {% endfor %}
            
            // Time range selector event listeners
            document.querySelectorAll('.time-range').forEach(button => {
                button.addEventListener('click', function() {
                    // Update active button
                    document.querySelectorAll('.time-range').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Get selected hours
                    const hours = parseInt(this.getAttribute('data-hours'));
                    
                    // Reload data for all GPUs
                    {% for gpu in metrics.gpus %}
                        loadMetricsData('{{ worker.worker_id }}', {{ loop.index0 }}, hours);
                    {% endfor %}
                });
            });
        {% endif %}
        
        // Function to load metrics data from API
        function loadMetricsData(workerId, gpuIndex, hours) {
            console.log(`Loading metrics data for worker ${workerId}, GPU ${gpuIndex}, hours: ${hours}`);
            // Clear any previous error messages
            document.querySelectorAll(`[id$='Chart${gpuIndex}']`).forEach(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            
            // Add loading indicator
            document.querySelectorAll(`[id$='Chart${gpuIndex}']`).forEach(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('Loading metrics data...', canvas.width/2 || 150, canvas.height/2 || 100);
            });
            
            // Use fetch with credentials to ensure cookies are sent
            fetch(`/api/metrics/history/${workerId}/${gpuIndex}?hours=${hours}&_=${new Date().getTime()}`, {
                credentials: 'same-origin',
                cache: 'no-cache' // Prevent caching
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Received metrics data for GPU ${gpuIndex}:`, data);
                    if (data.timestamps && data.timestamps.length > 0) {
                        console.log(`Got ${data.timestamps.length} data points for GPU ${gpuIndex}`);
                        updateCharts(data, gpuIndex);
                    } else {
                        console.log(`No data points available yet for GPU ${gpuIndex}. Charts will be empty.`);
                        // Still update charts with empty data to initialize them
                        updateCharts({
                            timestamps: [],
                            temperature: [],
                            utilization: [],
                            memory_utilization: [],
                            power_usage: []
                        }, gpuIndex);
                        
                        // Show a message that no data is available
                        document.querySelectorAll(`[id$='Chart${gpuIndex}']`).forEach(canvas => {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.font = '14px Arial';
                            ctx.fillStyle = '#666';
                            ctx.textAlign = 'center';
                            ctx.fillText('No data available yet. Data will appear as metrics are collected.', canvas.width/2 || 150, canvas.height/2 || 100);
                        });
                    }
                })
                .catch(error => {
                    console.error(`Error loading metrics data for GPU ${gpuIndex}:`, error);
                    // Display error message in the chart containers
                    document.querySelectorAll(`[id$='Chart${gpuIndex}']`).forEach(canvas => {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '14px Arial';
                        ctx.fillStyle = 'red';
                        ctx.textAlign = 'center';
                        ctx.fillText('Error loading metrics data. Check console for details.', canvas.width/2 || 150, canvas.height/2 || 100);
                    });
                });
        }
        
        // Function to update charts with new data
        function updateCharts(data, gpuIndex) {
            const timestamps = data.timestamps.map(ts => new Date(ts));
            
            // Temperature chart
            updateChart(
                `tempChart${gpuIndex}`,
                timestamps,
                data.temperature,
                'Temperature (°C)',
                'rgba(255, 99, 132, 0.5)',
                'rgba(255, 99, 132, 1)'
            );
            
            // Utilization chart
            updateChart(
                `utilChart${gpuIndex}`,
                timestamps,
                data.utilization,
                'GPU Utilization (%)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(54, 162, 235, 1)'
            );
            
            // Memory utilization chart
            updateChart(
                `memChart${gpuIndex}`,
                timestamps,
                data.memory_utilization,
                'Memory Utilization (%)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(75, 192, 192, 1)'
            );
            
            // Power usage chart
            updateChart(
                `powerChart${gpuIndex}`,
                timestamps,
                data.power_usage,
                'Power Usage (W)',
                'rgba(153, 102, 255, 0.5)',
                'rgba(153, 102, 255, 1)'
            );
        }
        
        // Helper function to create or update a chart
        function updateChart(chartId, labels, data, label, backgroundColor, borderColor) {
            const ctx = document.getElementById(chartId);
            if (!ctx) {
                console.error(`Canvas element with ID ${chartId} not found`);
                return;
            }
            
            console.log(`Updating chart ${chartId} with ${labels.length} data points`);
            
            // If no data, show a message and return
            if (!labels || labels.length === 0) {
                console.log(`No data available for chart ${chartId}`);
                // Destroy existing chart if it exists
                if (window[chartId]) {
                    window[chartId].destroy();
                    window[chartId] = null;
                }
                
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width || ctx.clientWidth, ctx.height || ctx.clientHeight);
                context.font = '14px Arial';
                context.fillStyle = '#666';
                context.textAlign = 'center';
                context.fillText('No data available yet. Data will appear as metrics are collected.', 
                                 (ctx.width || ctx.clientWidth) / 2, 
                                 (ctx.height || ctx.clientHeight) / 2);
                return;
            }
            
            // Process the data
            // Make sure all data points are numbers
            const processedData = data.map(val => typeof val === 'number' ? val : parseFloat(val) || 0);
            
            // Create new chart configuration
            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: processedData,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1,
                        tension: 0.1,
                        pointRadius: labels.length > 100 ? 0 : 1,  // Hide points if too many data points
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0  // Disable animation for better performance
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MMM d, HH:mm',
                                    minute: 'HH:mm'
                                },
                                tooltipFormat: 'MMM d, HH:mm:ss'
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxTicksLimit: 8,  // Limit the number of ticks for readability
                                source: 'auto',
                                autoSkip: true
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: label
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: label,
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let value = context.parsed.y;
                                    if (label.includes('Temperature')) {
                                        return `${value.toFixed(1)}°C`;
                                    } else if (label.includes('Utilization') || label.includes('Memory')) {
                                        return `${value.toFixed(1)}%`;
                                    } else if (label.includes('Power')) {
                                        return `${value.toFixed(1)}W`;
                                    }
                                    return value.toFixed(1);
                                }
                            }
                        },
                        legend: {
                            display: false  // Hide legend to save space
                        }
                    }
                }
            };
            
            // If chart with this ID already exists, destroy it
            if (window[chartId]) {
                window[chartId].destroy();
            }
            
            // Create new chart
            try {
                window[chartId] = new Chart(ctx, chartConfig);
                console.log(`Chart ${chartId} created successfully`);
            } catch (error) {
                console.error(`Error creating chart ${chartId}:`, error);
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width || ctx.clientWidth, ctx.height || ctx.clientHeight);
                context.font = '14px Arial';
                context.fillStyle = 'red';
                context.textAlign = 'center';
                context.fillText('Error creating chart. Check console for details.', 
                                 (ctx.width || ctx.clientWidth) / 2, 
                                 (ctx.height || ctx.clientHeight) / 2);
            }
        }
        
        // Function to update a single metric chart with detailed view
        function updateSingleMetricChart(gpuIndex, metricType, hours) {
            console.log(`Updating single metric chart for GPU ${gpuIndex}, metric: ${metricType}, hours: ${hours}`);
            
            // Get the worker ID from the page
            const workerId = '{{ worker.worker_id }}';
            
            // Fetch the data
            fetch(`/api/metrics/history/${workerId}/${gpuIndex}?hours=${hours}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.timestamps && data.timestamps.length > 0) {
                        const timestamps = data.timestamps.map(ts => new Date(ts));
                        let chartData, chartLabel, chartColor, chartBorderColor;
                        
                        // Set up chart parameters based on metric type
                        switch(metricType) {
                            case 'temperature':
                                chartData = data.temperature;
                                chartLabel = 'Temperature (°C)';
                                chartColor = 'rgba(255, 99, 132, 0.5)';
                                chartBorderColor = 'rgba(255, 99, 132, 1)';
                                break;
                            case 'utilization':
                                chartData = data.utilization;
                                chartLabel = 'GPU Utilization (%)';
                                chartColor = 'rgba(54, 162, 235, 0.5)';
                                chartBorderColor = 'rgba(54, 162, 235, 1)';
                                break;
                            case 'memory_utilization':
                                chartData = data.memory_utilization;
                                chartLabel = 'Memory Utilization (%)';
                                chartColor = 'rgba(75, 192, 192, 0.5)';
                                chartBorderColor = 'rgba(75, 192, 192, 1)';
                                break;
                            case 'power_usage':
                                chartData = data.power_usage;
                                chartLabel = 'Power Usage (W)';
                                chartColor = 'rgba(153, 102, 255, 0.5)';
                                chartBorderColor = 'rgba(153, 102, 255, 1)';
                                break;
                        }
                        
                        // Update the single metric chart
                        const chartId = `single${metricType.charAt(0).toUpperCase() + metricType.slice(1).replace('_', '')}Chart${gpuIndex}`;
                        updateDetailedChart(
                            chartId,
                            timestamps,
                            chartData,
                            chartLabel,
                            chartColor,
                            chartBorderColor
                        );
                    }
                })
                .catch(error => {
                    console.error(`Error loading single metric data for GPU ${gpuIndex}:`, error);
                });
        }
        
        // Function to create or update a detailed chart for single metric view
        function updateDetailedChart(chartId, labels, data, label, backgroundColor, borderColor) {
            const ctx = document.getElementById(chartId);
            if (!ctx) {
                console.error(`Canvas element with ID ${chartId} not found`);
                return;
            }
            
            console.log(`Updating detailed chart ${chartId} with ${labels.length} data points`);
            
            // Process data to handle null values
            const processedData = data.map((value, index) => {
                return value !== null ? value : null;
            });
            
            // Chart configuration with more detailed options
            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: processedData,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        tension: 0.2,
                        pointRadius: labels.length > 100 ? 0 : 2,
                        pointHoverRadius: 5,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: labels.length > 100 ? 'hour' : 'minute',
                                displayFormats: {
                                    hour: 'MMM d, HH:mm',
                                    minute: 'HH:mm'
                                },
                                tooltipFormat: 'MMM d, HH:mm:ss'
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxTicksLimit: 10,
                                source: 'auto',
                                autoSkip: true
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: label,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    if (label.includes('Temperature')) {
                                        return value + '°C';
                                    } else if (label.includes('Utilization') || label.includes('Memory')) {
                                        return value + '%';
                                    } else if (label.includes('Power')) {
                                        return value + 'W';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: label + ' History',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let value = context.parsed.y;
                                    if (label.includes('Temperature')) {
                                        return `${value.toFixed(1)}°C`;
                                    } else if (label.includes('Utilization') || label.includes('Memory')) {
                                        return `${value.toFixed(1)}%`;
                                    } else if (label.includes('Power')) {
                                        return `${value.toFixed(1)}W`;
                                    }
                                    return value.toFixed(1);
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            };
            
            // If chart with this ID already exists, destroy it
            if (window[chartId]) {
                window[chartId].destroy();
            }
            
            // Create new chart
            try {
                window[chartId] = new Chart(ctx, chartConfig);
                console.log(`Detailed chart ${chartId} created successfully`);
            } catch (error) {
                console.error(`Error creating detailed chart ${chartId}:`, error);
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width || ctx.clientWidth, ctx.height || ctx.clientHeight);
                context.font = '14px Arial';
                context.fillStyle = 'red';
                context.textAlign = 'center';
                context.fillText('Error creating chart. Check console for details.', 
                                 (ctx.width || ctx.clientWidth) / 2, 
                                 (ctx.height || ctx.clientHeight) / 2);
            }
        }
        
        // Initialize charts and set up event handlers
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing GPU metrics timeline and power limits...');
            
            // Fix for time range buttons - ensure 24 hours is selected by default
            const timeRangeButtons = document.querySelectorAll('.time-range');
            let activeButtonFound = false;
            
            timeRangeButtons.forEach(button => {
                if (button.classList.contains('active')) {
                    activeButtonFound = true;
                }
                
                // Add click event listeners to time range buttons
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log(`Time range button clicked: ${this.getAttribute('data-hours')} hours`);
                    
                    // Get GPU index if available
                    const gpuIndex = this.getAttribute('data-gpu-index');
                    
                    // Update active button styling for buttons in the same group
                    const buttonGroup = this.closest('.btn-group');
                    if (buttonGroup) {
                        buttonGroup.querySelectorAll('.time-range').forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                    } else {
                        // Fallback to updating all buttons
                        timeRangeButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                    }
                    
                    // Get new time range
                    const hours = parseInt(this.getAttribute('data-hours'));
                    
                    // If GPU index is specified, only reload data for that GPU
                    if (gpuIndex) {
                        console.log(`Reloading data for specific GPU ${gpuIndex} with ${hours} hour timeframe`);
                        loadMetricsData('{{ worker.worker_id }}', gpuIndex, hours);
                        
                        // If a single metric view is active, update that too
                        const metricSelector = document.getElementById(`metric-select-${gpuIndex}`);
                        if (metricSelector && metricSelector.value !== 'all') {
                            updateSingleMetricChart(gpuIndex, metricSelector.value, hours);
                        }
                    } else {
                        // Reload data for all GPUs with new time range
                        {% if metrics and metrics.gpus %}
                            {% for gpu in metrics.gpus %}
                                console.log(`Reloading data for GPU {{ loop.index0 }} with ${hours} hour timeframe`);
                                loadMetricsData('{{ worker.worker_id }}', {{ loop.index0 }}, hours);
                                
                                // Check if single metric view is active
                                const metricSelector = document.getElementById(`metric-select-{{ loop.index0 }}`);
                                if (metricSelector && metricSelector.value !== 'all') {
                                    updateSingleMetricChart({{ loop.index0 }}, metricSelector.value, hours);
                                }
                            {% endfor %}
                        {% endif %}
                    }
                });
            });
            
            // If no active button was found, set the 24h button as active by default
            if (!activeButtonFound) {
                const defaultButton = document.querySelector('.time-range[data-hours="24"]');
                if (defaultButton) {
                    defaultButton.classList.add('active');
                }
            }
            
            // Set up metric selectors
            document.querySelectorAll('.metric-selector').forEach(selector => {
                selector.addEventListener('change', function() {
                    const gpuIndex = this.getAttribute('data-gpu-index');
                    const selectedMetric = this.value;
                    
                    console.log(`Metric selector changed for GPU ${gpuIndex}: ${selectedMetric}`);
                    
                    // Hide all metric views for this GPU
                    document.querySelectorAll(`[id$="-view-${gpuIndex}"]`).forEach(view => {
                        view.classList.add('d-none');
                    });
                    
                    if (selectedMetric === 'all') {
                        // Show all metrics view
                        document.getElementById(`all-metrics-${gpuIndex}`).classList.remove('d-none');
                    } else {
                        // Show selected metric view
                        const metricView = document.getElementById(`${selectedMetric}-view-${gpuIndex}`);
                        if (metricView) {
                            metricView.classList.remove('d-none');
                            
                            // Get current time range
                            const activeButton = document.querySelector(`.time-range[data-gpu-index="${gpuIndex}"].active`) || 
                                               document.querySelector(`.time-range.active`);
                            const hours = activeButton ? parseInt(activeButton.getAttribute('data-hours')) : 24;
                            
                            // Load data and update single metric chart
                            updateSingleMetricChart(gpuIndex, selectedMetric, hours);
                        }
                    }
                });
            });
            
            // Initial load of metrics data for all GPUs
            {% if metrics and metrics.gpus %}
                {% for gpu in metrics.gpus %}
                    // Get current time range from active button
                    const activeButton = document.querySelector('.time-range.active');
                    const hours = activeButton ? parseInt(activeButton.getAttribute('data-hours')) : 24;
                    
                    console.log(`Initial load of metrics for GPU {{ loop.index0 }} with ${hours} hour timeframe`);
                    loadMetricsData('{{ worker.worker_id }}', {{ loop.index0 }}, hours);
                {% endfor %}
                
                // Load initial power limits data
                console.log('Loading initial power limits data');
                setTimeout(() => {
                    loadPowerLimits('{{ worker.worker_id }}');
                }, 1500);
            {% endif %}
        });
        
        // Setup polling for real-time updates - refresh metrics every 30 seconds
        const metricsUpdateInterval = setInterval(function() {
            console.log('Automatic refresh of metrics data');
            {% if metrics and metrics.gpus %}
                {% for gpu in metrics.gpus %}
                    // Get current time range from active button
                    const activeButton = document.querySelector('.time-range.active');
                    const hours = activeButton ? parseInt(activeButton.getAttribute('data-hours')) : 24;
                    
                    // Reload data
                    loadMetricsData('{{ worker.worker_id }}', {{ loop.index0 }}, hours);
                {% endfor %}
            {% endif %}
        }, 30000); // Update every 30 seconds for more responsive updates
        
        // GPU Overclocking functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load power limits on page load
            console.log('Initializing power limits on page load');
            setTimeout(() => {
                loadPowerLimits('{{ worker.worker_id }}');
            }, 1000); // Slight delay to ensure DOM is fully loaded
            
            // Refresh power limits button
            const refreshButton = document.getElementById('refresh-power-limits');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    console.log('Refresh power limits button clicked');
                    loadPowerLimits('{{ worker.worker_id }}');
                });
            }
            
            // Set up TDP form submission handlers
            const tdpForms = document.querySelectorAll('.tdp-form');
            tdpForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const gpuIndex = formData.get('gpu_index');
                    const powerLimit = formData.get('power_limit');
                    
                    if (!powerLimit) {
                        alert('Please enter a power limit value');
                        return;
                    }
                    
                    console.log(`Submitting power limit ${powerLimit}W for GPU ${gpuIndex}`);
                    
                    // Show loading state
                    const statusDiv = document.getElementById(`tdp-status-${gpuIndex}`);
                    if (statusDiv) {
                        statusDiv.className = 'alert alert-info';
                        statusDiv.textContent = `Setting power limit to ${powerLimit}W...`;
                        statusDiv.classList.remove('d-none');
                    }
                    
                    console.log(`Submitting power limit request for GPU ${gpuIndex}: ${powerLimit}W`);
                    
                    // Send request to set TDP
                    fetch('/api/gpu/set_tdp', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('TDP set response:', data);
                        if (data.status === 'success') {
                            if (statusDiv) {
                                statusDiv.className = 'alert alert-success';
                                statusDiv.textContent = data.message || 'Power limit set successfully';
                            }
                            
                            // Refresh power limits after a delay to show the new values
                            console.log('Power limit set successfully, will refresh limits in 3 seconds');
                            setTimeout(() => {
                                loadPowerLimits('{{ worker.worker_id }}');
                            }, 3000);
                        } else {
                            if (statusDiv) {
                                statusDiv.className = 'alert alert-danger';
                                statusDiv.textContent = `Error: ${data.message || 'Failed to set power limit'}`;
                            }
                            console.error('Error response from server:', data);
                        }
                    })
                    .catch(error => {
                        console.error('Error setting TDP:', error);
                        if (statusDiv) {
                            statusDiv.className = 'alert alert-danger';
                            statusDiv.textContent = `Error: ${error.message || 'Network error when setting power limit'}`;
                        }
                    });
                });
            });
        });
        
        // Function to load power limits for all GPUs
        function loadPowerLimits(workerId) {
            // Show loading state
            const loadingDiv = document.getElementById('power-limits-loading');
            const dataDiv = document.getElementById('power-limits-data');
            
            if (loadingDiv && dataDiv) {
                loadingDiv.classList.remove('d-none');
                dataDiv.classList.add('d-none');
                
                console.log('Requesting power limits for worker:', workerId);
                
                // Request power limits
                fetch(`/api/gpu/get_power_limits?worker_id=${workerId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Power limits request response:', data);
                        if (data.status === 'success' && data.command_id) {
                            // Wait for the command to complete and then check its output
                            setTimeout(() => {
                                checkPowerLimitsCommand(data.command_id);
                            }, 500); // Short delay to allow command to start executing
                        } else {
                            showPowerLimitsError(data.message || 'Failed to get power limits');
                        }
                    })
                    .catch(error => {
                        console.error('Error requesting power limits:', error);
                        showPowerLimitsError(error.message || 'Network error when requesting power limits');
                    });
            }
        }
        
        // Function to check the power limits command output
        function checkPowerLimitsCommand(commandId) {
            console.log('Checking power limits command status:', commandId);
            fetch(`/command_output/${commandId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Command status:', data);
                    if (data.status === 'completed') {
                        // Parse the command output to get power limits
                        if (data.output && data.output.trim() !== '') {
                            parsePowerLimitsOutput(data.output);
                        } else {
                            showPowerLimitsError('No output received from command. Please try refreshing.');
                        }
                    } else if (data.status === 'running' || data.status === 'pending') {
                        // Command still running, check again after a delay
                        console.log('Command still running, checking again in 1 second...');
                        setTimeout(() => {
                            checkPowerLimitsCommand(commandId);
                        }, 1000);
                    } else if (data.status === 'failed') {
                        // Command failed
                        showPowerLimitsError(`Command failed to execute. The worker might not have GPU overclocking capabilities.`);
                    } else {
                        // Other status
                        showPowerLimitsError(`Command status: ${data.status}. Please try refreshing.`);
                })
                .catch(error => {
                    console.error('Error checking power limits command:', error);
                    showPowerLimitsError(error.message || 'Network error when checking command status');
                });
        }
        
        // Function to parse the power limits command output
        function parsePowerLimitsOutput(output) {
            try {
                console.log('Parsing power limits output:', output);
                
                // Handle empty or invalid output
                if (!output || output.trim() === '') {
                    showPowerLimitsError('No power limits data received from the server');
                    return;
                }
                
                const lines = output.trim().split('\n');
                const powerLimitsData = document.getElementById('power-limits-data');
                const loadingDiv = document.getElementById('power-limits-loading');
                
                if (lines.length > 0 && powerLimitsData) {
                    // Create a table to display the power limits
                    let html = `
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>GPU</th>
                                    <th>Current Limit (W)</th>
                                    <th>Default Limit (W)</th>
                                    <th>Min Limit (W)</th>
                                    <th>Max Limit (W)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    let foundValidData = false;
                    
                    lines.forEach(line => {
                        // Skip empty lines
                        if (!line.trim()) return;
                        
                        console.log('Processing line:', line);
                        const parts = line.split(',').map(part => part.trim());
                        
                        // Check if we have all the required parts
                        if (parts.length >= 5) {
                            foundValidData = true;
                            const [index, currentLimit, defaultLimit, minLimit, maxLimit] = parts;
                            
                            // Convert values to numbers and format them
                            const currentLimitNum = parseFloat(currentLimit) || 0;
                            const defaultLimitNum = parseFloat(defaultLimit) || 0;
                            const minLimitNum = parseFloat(minLimit) || 0;
                            const maxLimitNum = parseFloat(maxLimit) || 0;
                            
                            html += `
                                <tr>
                                    <td>${index}</td>
                                    <td>${currentLimitNum.toFixed(1)}</td>
                                    <td>${defaultLimitNum.toFixed(1)}</td>
                                    <td>${minLimitNum.toFixed(1)}</td>
                                    <td>${maxLimitNum.toFixed(1)}</td>
                                </tr>
                            `;
                            
                            // Update the current and max power limit displays
                            const currentSpan = document.querySelector(`.current-power-limit[data-gpu-index="${index}"]`);
                            const maxSpan = document.querySelector(`.max-power-limit[data-gpu-index="${index}"]`);
                            
                            if (currentSpan) currentSpan.textContent = `${currentLimitNum.toFixed(1)}W`;
                            if (maxSpan) maxSpan.textContent = `${maxLimitNum.toFixed(1)}W`;
                            
                            // Update the power limit input field with the current value as placeholder
                            const inputField = document.getElementById(`power-limit-${index}`);
                            if (inputField) {
                                inputField.placeholder = currentLimitNum.toFixed(0);
                                inputField.min = minLimitNum;
                                inputField.max = maxLimitNum;
                                inputField.value = ''; // Clear any previous value
                            }
                        }
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    if (foundValidData) {
                        // Update the UI
                        powerLimitsData.innerHTML = html;
                        powerLimitsData.classList.remove('d-none');
                        loadingDiv.classList.add('d-none');
                    } else {
                        showPowerLimitsError('Could not parse power limits data. Format not recognized.');
                    }
                } else {
                    showPowerLimitsError('No power limits data available');
                }
            } catch (error) {
                console.error('Error parsing power limits output:', error);
                showPowerLimitsError(error.message || 'Error parsing power limits data');
            }
        }
        
        // Function to show power limits error
        function showPowerLimitsError(message) {
            const loadingDiv = document.getElementById('power-limits-loading');
            const dataDiv = document.getElementById('power-limits-data');
            
            if (loadingDiv && dataDiv) {
                loadingDiv.classList.add('d-none');
                dataDiv.classList.remove('d-none');
                dataDiv.innerHTML = `<div class="alert alert-danger">${message}</div>`;
            }
        }
    </script>
</body>
</html>
